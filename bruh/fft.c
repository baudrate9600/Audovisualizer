#include <math.h>
#include "fft.h"
#include <avr/io.h>
#define PI 3.14159265359
#define TWO_PI 6.28318530718
#define FIXED_POINT 100000
#define OUTER_LOOP 6    
#define INNER_LOOP 32

unsigned int Log2n(unsigned int n ){
    return (n>1) ? 1 + Log2n(n/2) : 0;
}
unsigned int reversedNumber(unsigned int numberToBeReversed, unsigned int bitSpan){
    unsigned int num = 0;
     {
    for (int i = 0; i < bitSpan; i++)
        if (numberToBeReversed & (1 << (bitSpan-i-1)))
        {
            num |= (1 << i);
        }else
        {
            num &= ~(1 << i );
        }
    }
    return num;
}

scomplex multiply(scomplex x, scomplex y){
	scomplex mult;
	mult.real = x.real * y.real -(x.imag*y.imag);
	mult.imag = x.real * y.imag + x.imag *y.real;
	return mult;
}
scomplex add(scomplex x, scomplex y){
	scomplex ad; 
	ad.real = x.real + y.real; 
	ad.imag = x.imag + y.imag;
	return ad;
}
scomplex subtract(scomplex x, scomplex y){
	scomplex sub; 
	sub.real = x.real - y.real; 
	sub.imag = x.imag - y.imag;
	return sub;
}
float magnitude(scomplex x){
	return sqrt( x.real*x.real + x.imag*x.imag);
}
int imagnitude(scomplex x){
	return (int) sqrt(x.real*x.real + x.imag*x.imag);
}


int odd,even;
scomplex cmplxPart;	
int val;
void fft(scomplex * samples){
	int counter = 0;
	//determines the offset between odd and even 
	int line = 1;
	//number of stages 
	//        N
	// X[k] = Î£ x_k W_n
	//       n=0 
	
	int stride = 0;
	for (int i = 0; i < OUTER_LOOP; i++){
		counter = 0;
		int offset = 0; 
		for(int j = 0; j < INNER_LOOP; j++){
			if(counter == line){
				counter = 0;
				offset += line;
			}	
			val = stride + counter;
			cmplxPart.real = lut_cos[val];
			cmplxPart.imag = lut_sin[val];

			even = j+offset;
			odd = even + line;

			cmplxPart = multiply(samples[odd],cmplxPart);
			samples[odd] = subtract(samples[even],cmplxPart);
			samples[even] = add(samples[even], cmplxPart);
			counter ++;

		}
		stride = stride + line; 
		line = line * 2;
	}

}
/*
float cos_lut[5][16] = {
        {1,         1,         1,         1,         1,         1,         1,         1,         1,         1,         1,         1,         1,         1,         1,         1},
        {1,         0,         1,         0,         1,         0,         1,         0,         1,         0,         1,         0,         1,         0,         1,         0},
        {1,   0.70711,         0,  -0.70711,         1,   0.70711,         0,  -0.70711,         1,   0.70711,         0,  -0.70711,         1,   0.70711,         0,  -0.70711},
        {1,   0.92388,   0.70711,   0.38268,         0,  -0.38268,  -0.70711,  -0.92388,         1,   0.92388,   0.70711,   0.38268,         0,  -0.38268,  -0.70711,  -0.92388},
        {1,   0.98079,   0.92388,   0.83147,   0.70711,   0.55557,   0.38268,   0.19509,         0,  -0.19509,  -0.38268,  -0.55557,  -0.70711,  -0.83147,  -0.92388,  -0.98079}
};

float sin_lut[5][16] ={
        {0,         0,         0,         0,         0,         0,         0,         0,         0,         0,         0,         0,         0,         0,         0,         0},
        {0,        -1,         0,        -1,         0,        -1,         0,        -1,         0,        -1,         0,        -1,         0,        -1,         0,        -1},
        {0,  -0.70711,        -1,  -0.70711,         0,  -0.70711,        -1,  -0.70711,         0,  -0.70711,        -1,  -0.70711,         0,  -0.70711,        -1,  -0.70711},
        {0,  -0.38268,  -0.70711,  -0.92388,        -1,  -0.92388,  -0.70711,  -0.38268,         0,  -0.38268,  -0.70711,  -0.92388,        -1,  -0.92388,  -0.70711,  -0.38268},
        { 0,  -0.19509,  -0.38268,  -0.55557,  -0.70711,  -0.83147,  -0.92388,  -0.98079,        -1,  -0.98079,  -0.92388,  -0.83147,  -0.70711,  -0.55557,  -0.38268,  -0.19509},
};
*/


float hanning[64] = {0, 0.00240764, 0.00960736, 0.0215298, 0.0380602, 0.0590394, 0.0842652, 0.113495, 0.146447, 0.182803, 0.222215, 0.264302, 0.308658, 0.354858, 0.402455, 0.450991, 0.5, 0.549009, 0.597545, 0.645142, 0.691342, 0.735698, 0.777785, 0.817197, 0.853553, 0.886505, 0.915735, 0.940961, 0.96194, 0.97847, 0.990393, 0.997592, 1, 0.997592, 0.990393, 0.97847, 0.96194, 0.940961, 0.915735, 0.886505, 0.853553, 0.817197, 0.777785, 0.735698, 0.691342, 0.645142, 0.597545, 0.549009, 0.5, 0.450991, 0.402455, 0.354858, 0.308658, 0.264302, 0.222215, 0.182803, 0.146447, 0.113495, 0.0842652, 0.0590394, 0.0380602, 0.0215298, 0.00960736, 0.00240764};

uint8_t reversed[64] = {0, 32, 16, 48, 8, 40, 24, 56, 4, 36, 20, 52, 12, 44, 28, 60, 2, 34, 18, 50, 10, 42, 26, 58, 6, 38, 22, 54, 14, 46, 30, 62, 1, 33, 17, 49, 9, 41, 25, 57, 5, 37, 21, 53, 13, 45, 29, 61, 3, 35, 19, 51, 11, 43, 27, 59, 7, 39, 23, 55, 15, 47, 31, 63};


float lut_cos[63] = {1, 1, 0, 1, 0.707107, 0, -0.707107, 1, 0.92388, 0.707107, 0.382683, 0, -0.382683, -0.707107, -0.92388, 1, 0.980785, 0.92388, 0.83147, 0.707107, 0.55557, 0.382683, 0.19509, 0, -0.19509, -0.382683, -0.55557, -0.707107, -0.83147, -0.92388, -0.980785, 1, 0.995185, 0.980785, 0.95694, 0.92388, 0.881921, 0.83147, 0.77301, 0.707107, 0.634393, 0.55557, 0.471397, 0.382683, 0.290285, 0.19509, 0.0980171, 0, -0.0980171, -0.19509, -0.290285, -0.382683, -0.471397, -0.55557, -0.634393, -0.707107, -0.77301, -0.83147, -0.881921, -0.92388, -0.95694, -0.980785, -0.995185};


float lut_sin[63] = {0, 0, -1, 0, -0.707107, -1, -0.707107, 0, -0.382683, -0.707107, -0.92388, -1, -0.92388, -0.707107, -0.382683, 0, -0.19509, -0.382683, -0.55557, -0.707107, -0.83147, -0.92388, -0.980785, -1, -0.980785, -0.92388, -0.83147, -0.707107, -0.55557, -0.382683, -0.19509, 0, -0.0980171, -0.19509, -0.290285, -0.382683, -0.471397, -0.55557, -0.634393, -0.707107, -0.77301, -0.83147, -0.881921, -0.92388, -0.95694, -0.980785, -0.995185, -1, -0.995185, -0.980785, -0.95694, -0.92388, -0.881921, -0.83147, -0.77301, -0.707107, -0.634393, -0.55557, -0.471397, -0.382683, -0.290285, -0.19509, -0.0980171};
